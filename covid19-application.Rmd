---
title: "COVID19 application"
author: "Ana Xiangning Pereira Ezquerro"
date:  "Versión `r format(Sys.time(), '%d %B, %Y')`"
output:
  pdf_document:
    number_sections: yes
    latex_engine: lualatex
    fig_caption: yes
    toc: yes
    highlight: tango
    df_print: kable
    citation_package: biblatex
  html_document:
    toc: true
    toc_float: true
    df_print: paged
    number_sections: true
    theme: paper
    highlight: tango
  prettydoc::html_pretty:
    toc: true
    df_print: paged
    number_sections: true
    theme: hpstr
    highlight: github
fontsize: 12pt
geometry: margin=0.7in
classoption: a4paper
documentclass: article
header-includes:
- \usepackage{sfmath}
- \renewcommand*\familydefault{\sfdefault}
- \renewcommand{\baselinestretch}{1.2}
- \setlength{\parskip}{1em}
- \usepackage{xcolor}
- \input{confi.tex}
always_allow_html: yes
bibliography: references.bib
biblio-style: bwl-FU
linkcitations: true
linkcolor: blue
lang: es
---

```{r, echo=F, warning=F, message=F}
# Cargamos las funciones
knitr::opts_chunk$set(fig.align='center', fig.width = 10, 
                      fig.height = 8, message=F, comment='', warning=F)
eval(parse("plot_tools.R", encoding="UTF-8"))
eval(parse("arima_simulation.R", encoding="UTF-8"))
eval(parse("auto_fitting.R", encoding="UTF-8"))
eval(parse("auto_selection.R", encoding="UTF-8"))
eval(parse("forecasting.R", encoding="UTF-8"))

# Librerías de series temporales
library(fpp2)
library(tseries)
library(TSA)
library(seastests)
library(forecast)

# Librerías para los gráficos
library(plotly)
library(forecast)

# Auxiliares
library(prettydoc)
library(stringi)
library(stringr)
library(polynom)
library(parallel)

# Función para mostrar y guardar las gráficas de plotly
display <- function(fig, name, width=800, height=400) {
  
  if (is.null(knitr::opts_knit$get("rmarkdown.pandoc.to"))) {
    return(fig)
  }
  if (knitr::opts_knit$get("rmarkdown.pandoc.to") == "latex") {
    figpath <- paste0('figures/', name, ".pdf")
    save_image(fig, figpath, width=width, height=height)
    return(knitr::include_graphics(figpath))
  }
  if (knitr::opts_knit$get("rmarkdown.pandoc.to") == "html") {
    fig <- fig %>% layout(width=840, height=700)
    return(fig)
  }
}

dir.create("figures", showWarnings=F)
```

\vspace{2em}


In this document we evaluate our selection method in the IRAS dataset, aiming to study the impact of aggregated data (by age and demographical variables) of acute respiratory infections (ARIs) and vaccination progress to the COVID19 evolution in Catalonia (Spain).

The original IRAS dataset contains individual weekly data about ARIs cases. In order to preserve confidentiality and privacy of the patients, this dataset  was aggregated by week, filtered and parsed to obtain a new dataset with the following variables:


* `fecha` [`char`]: Time variable which indicates the week of the aggregated data (format *YYYY-WW*).
* `sdgripal`  [`int`]: Total number of influenza cases in Catalonia.
* `sarscov2` [`int`]: Total number of COVID-9 cases in Catalonia.
* `edad04.sdgripal` [`int`]: Number of influenza cases in the age range from $0$ up to $4$ years.
* `edad04.sarscov2` [`int`]: Number of COVID-19 cases in the age range from $0$ up to $4$ years.
* `edad514.sdgripal` [`int`]: Number of influenza cases in the age range from $5$ up to $14$ years.
* `edad514.sarscov2` [`int`]: Number of COVID-19 cases in the age range from $5$ up to $14$ years.
* `edad1544.sdgripal` [`int`]: Number of influenza cases in the age range from $15$ up to $44$ years.
* `edad1544.sarscov2` [`int`]: Number of COVID-19 cases in the age range from $15$ up to $44$ years.
* `edad4565.sdgripal` [`int`]: Number of influenza cases in the age range from $45$ up to $64$ years.
* `edad4565.sarscov2` [`int`]: Number of COVID-19 cases in the age range from $45$ up to $64$ years.
* `edad65.sdgripal` [`int`]: Number of influenza cases in the age range from $65$.
* `edad65.sarscov2` [`int`]: Number of COVID-19 cases in the age range from $65$.
* `pob04` [`int`]: Scaled population in Catalonia in the age range from $0$ up to $4$ years.
* `pob514` [`int`]: Scaled population in Catalonia in the age range from $5$ up to $14$ years.
* `pob1544` [`int`]: Scaled population in Catalonia in the age range from $15$ up to $44$ years.
* `pob4565` [`int`]: Scaled population in Catalonia in the age range from $45$ up to $64$ years.
* `pob56` [`int`]: Scaled population in Catalonia in the age range from $65$.
* `PIRINEU.sdgripal` [`int`]: Number of influenza cases in the *Alt Pirineu i Aran* Health Area.
* `PIRINEU.sarscov2` [`int`]: Number of COVID-19 cases in the *Alt Pirineu i Aran* Health Area.
* `BARCELONA.sdgripal` [`int`]: Number of influenza cases in *Barcelona Ciutat* Health Area.
* `BARCELONA.sarscov2` [`int`]: Number of COVID-19 cases in *Barcelona Ciutat* Health Area.
* `CATALUNYA.sdgripal` [`int`]: Number of influenza cases in *Catalunya Central* Health Area.
* `CATALUNYA.sarscov2` [`int`]: Number of COVID-19 cases in *Catalunya Central* Health Area.
* `GIRONA.sdgripal` [`int`]: Number of influenza cases in *Girona* Health Area.
* `GIRONA.sarscov2` [`int`]: Number of COVID-19 cases in *Girona* Health Area.
* `LLEIDA.sdgripal` [`int`]: Number of influenza cases in *Lleida* Health Area.
* `LLEIDA.sarscov2` [`int`]: Number of COVID-19 cases in *Lleida* Health Area.
* `METR_NORD.sdgripal` [`int`]: Number of influenza cases in *Metropolitan Nord* Health Area of Barcelona.
* `METR_NORD.sarscov2` [`int`]: Number of COVID-19 cases in *Metropolitan Nord* Health Area of Barcelona.
* `METR_SUD.sdgripal` [`int`]: Number of influenza cases in *Metropolitan Sud* Health Area of Barcelona.
* `METR_SUD.sarscov2` [`int`]: Number of COVID-19 cases in *Metropolitan Sud* Health Area of Barcelona.
* `TARRAGONA.sdgripal` [`int`]: Number of influenza cases in *Camp of Tarragona* Health Area.
* `TARRAGONA.sarscov2` [`int`]: Number of COVID-19 cases in *Camp of Tarragona* Health Area.
* `TERRES_EBRE.sdgripal` [`int`]: Number of influenza cases in *Terres de l'Ebre* Health Area.
* `TERRES_EBRE.sarscov2` [`int`]: Number of COVID-19 cases in *Terres de l'Ebre* Health Area.
* `VALLES.sdgripal` [`int`]: Number of influenza cases in *Valles* Health Area.
* `VALLES.sarscov2` [`int`]: Number of COVID-19 cases in *Valles* Health Area.
* `vac1218`[`int`]: Number of vaccinations in the age range from $12$ up to $18$ years (exclusive).
* `vac1845`[`int`]: Number of vaccinations in the age range from $18$ up to $45$ years (exclusive).
* `vac4565`[`int`]: Number of vaccinations in the age range from $45$ up to $65$ years (exclusive).
* `vac6580`[`int`]: Number of vaccinations in the age range from $65$ up to $80$ years (exclusive).
* `vac80`[`int`]: Number of vaccinations in the age range from $80$ years.
* `vactotal`[`int`]: Number of total vaccinations in Catalonia.

Note that age ranges in vaccination and IRAS data do not match. This is due to the different sources of each dataset.




```{r}
cataluna <- read.csv("data/evolucion_gripe_covid.csv")
```




# COVID-19 evolution, influenza impact and vaccination progress 

## Study on global data

In this section we analyze the impact of the influenza cases and vaccination progress to the COVID-19 evolution. Let's assume we want to model, if it exists, the correlation between the COVID-19 evolution (dependent variable) and influenza and vaccination progress (candidate covariates).



We construct a new time series matrix containing only the necessary variables:

```{r}
sarscov2 <- ts(cataluna$sarscov2)
xregs <- ts(cataluna[, c('sdgripal', 'vactotal')])
```

And use the function `auto.fit.arima.regression()` with the following configuration:

* The information criterion used is the AICc (`ic="aicc"`).
* The significant level used in the hypthesis tests is $0.05$ (`alpha=0.05`).
* The stationary property is checked by adjusting an ARIMA(p,d,q) and analyzing the $d$ order (`stationary_method="auto.arima"`).


```{r}
adjust <- auto.fit.arima.regression(sarscov2, xregs, 
            ic='aicc', alpha=0.05, stationary_method='auto.arima', show_info=T)
```


Our selection method states that there is a significant correlation between the influenza cases and vaccination progress of the Catalan population and the COVID-19 evolution in this region. This relation can be defined as a dynamic linear regression model with the form:

$$ 
    \text{sarscov2}_t = 0.7062 \cdot \text{sdgripal}_t - 0.0063 \cdot \text{vactotal}_{t-9} + \eta_t, \qquad \eta_t\sim \text{ARIMA(2,0,1)}
$$
where $\phi_1=1.8208$, $\phi_2=-0.8982$ and $\theta_1 = -0.8046$ are the AR and MA coefficients, respectively, of $\eta_t$.

Thus, our selection approach confirms the existence of correlation between the current influenza cases and COVID-19 evolution, and the negative impact (with approximately 3 weeks delay) of the vaccination progress in the virus confirmed cases.

## Study on vaccination data aggregated by group of ages

Once we have confirmed the existence of relation between the COVID-19 confirmed cases and vaccination progress in Catalonia, it might be relevant to investigate if the vaccination of some group of ages have more or less impact in the COVID-19 evolution. Since our database provides us of grouped vaccination data, we can launch again the selection function with the same configuration and interpret its result.

```{r}
sarscov2 <- ts(cataluna$sarscov2)
xregs <- ts(cataluna[, c('vac1218', 'vac1845', 'vac4565', 'vac6580', 'vac80')])
adjust <- auto.fit.arima.regression(sarscov2, xregs, 
            ic='aicc', alpha=0.05, stationary_method='auto.arima', show_info=T)
```

As our natural reasoning might suspect, by separating the vaccionations by group of ages, our selection method states that:

* There is a lagged negative correlation between the vaccination data and COVID-19 evolution.
* The vaccination of the population between 65 and 80 years has a greater impact in the COVID19 confirmed cases than the rest of population (the coefficient magnitude is greater and the impact delay is smaller).
* The vaccination of the youngest population (from 12 up to 18 years old) has some impact in the COVID19 evolution, but the standard deviation of the estimated coefficient is greater.


In addition, our implemented function `forecast_model()` makes predictions at horizon $h$ by introducing the original data and the result of the function `auto.fit.arima.regression()`. 

```{r}
preds <- forecast_model(sarscov2, xregs, adjust, h=10, 
                        mode='bootstrap', levels=c(50, 75, 90))
fig <- plot_forecast(preds)

# change x axis
time_vec <- window(cataluna$fecha, start=start(preds$x))
fig <- fig %>% layout(
    xaxis = list(
        ticktext = c('2021', '2022'),
        tickvals = time(time_vec)[1] + 
            c(
                which(str_detect(time_vec, '2021'))[1],
                which(str_detect(time_vec, '2022'))[1]
              ),
        tickmode = 'array'
    )
)

display(plot_forecast(preds), name='preds_covid19_vac')
```



