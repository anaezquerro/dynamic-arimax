---
title: "Código Bolsas de Colaboración"
author: "Ana Xiangning Pereira Ezquerro"
date: "Curso 2021-2022"
output:
  pdf_document:
    number_sections: yes
    latex_engine: lualatex
    fig_caption: yes
    toc: yes
    highlight: tango
    df_print: kable
  html_document:
    toc: true
    toc_float: true
    df_print: paged
    number_sections: true
    theme: united
    highlight: tango
fontsize: 12pt
geometry: margin=0.7in
classoption: a4paper
documentclass: article
header-includes:
- \usepackage{sfmath}
- \renewcommand*\familydefault{\sfdefault}
- \renewcommand{\P}{\mathbb{P}}
- \newcommand{\x}{\mathbf{x}}
- \newcommand{\X}{\mathbf{X}}
- \newcommand{\N}{\mathbb{N}}
- \newcommand{\I}{\mathbb{I}}
- \newcommand{\hT}{\hat{T}}
always_allow_html: yes
---



```{r, echo=F, warning=F, message=F}
knitr::opts_chunk$set(fig.align='center', fig.width = 8, 
                      fig.height = 5, message=F, warning = F,
                      comment='')

library(TSA)
library(tseries)
library(fpp2)
```


# Regresión con series de tiempo
## Correlación espuria

Consideremos la serie de ventas semanales transformadas a traves del log() y el precio de patatas fritas *Bluebird* de Nueva Zelanda. El período de observación es de 104 semanas (desde el 20 de Septiembre de 1988 hasta el 10 de Septiembre de 2000).


Vamos a construir un modelo de regresión para explicar las ventas a través del precio de las patatas. Posteriormente, lo utilizaremos para realizar predicciones.


```{r}
load("data/patatas.dat")

# La primera columna tiene el log(ventas) y la segunda columnas el precio de las patatas
Y <- patatas[, 1]
X <- patatas[, 2]
```


### Construcción y ajuste del modelo

\[ \log(\text{Ventas}) = \beta_0 + \beta_1 \text{Precio}_{t-r} + \varepsilon_t \]

donde $\varepsilon_t$ sigue un ARMA.


Por tanto habrá que:

1. Asesorarase acerca de si realmente es justificable este tipo de relación (relación lineal).
2. En caso de que así sea, habrá que identificar:
  2.1. El valor de $r$.
  2.2. Los órdenes del ARMA.

Para responder a (1) y (2.1) aplicaremos el **preblanqueo** sobre series estacionarias.


Veamos si las series en estudio son estacionarias:


```{r}
autoplot(patatas, facets=TRUE)
```


A juzgar por el gráfico, estas series no parecen estacionarias.

```{r, fig.width=10, fig.height=5}
par(mfrow=c(1, 2))
acf(Y)
acf(X)
```

las correlaciones decrecen rápidamente a cero (siendo ésta una características de las series estacionarias). Podemos tratar de resolver la duda a través del est de Dickey-Fuller, que contrasta la hipótesis nula de no estacionariedad (más específicamente, la existenca de raíces unitarias).


```{r}
adf.test(Y)
adf.test(X)
```

En ambos casos vemos que el contraste no rechaza la no estcionariedad (al 5%). Supondremos por tanto, en lo que a la identificación de $r$ se refiere, no estacionariedad (esto es, preblanquearemos las series diferenciadas). Si supusiésemos estacionariedad y preblanqueásemos las series originales, la conclusión acerca de $r$ sería la misma.


Veamos si las series diferenciadas son o no estacionarias:

```{r}
autoplot(diff(patatas, facets=TRUE))
```


```{r, fig.width=12, fig.height=8}
par(mfrow=c(2, 2))
acf(diff(Y))
acf(diff(X))
pacf(diff(Y))
pacf(diff(X))
```


Como podemos comprobar a partir de los gráficos, la diferenciación regular da lugar a series estacionarias. A continuación vamos a preblanquearlas y a mostrar sus correlaciones cruzadas.

```{r}
TSA::prewhiten(x = diff(X), y = diff(Y), xlab="lag", ylab="CCF",
               main="Correlaciones cruzadas: series preblanqueadas")
```

A partir del gráfico de correlaciones cruzadas de las series preblanqueads sugerimos:

* Existencia de relación lineal con $r=0$. Esto es, **relación contemporánea** o **instantánea**.
* Por tanto nuestro modelo quedaría de la forma:

\[ \log(\text{Ventas}_t) = \beta_0 + \beta_1 \text{Precio}_t + \varepsilon_t \]


### Modelo ARMA para los errores $\{ \varepsilon_t \}$

Sugerimos aquel ARMA que da lugar al menor valor AICc en la estimación del modelo de regresión.

```{r}
ajuste <- auto.arima(Y, xreg=X, d=0, D=0, stepwise=FALSE, approximation=FALSE, trace=TRUE)
```


Una vez ajustado el modelo, vamos a comprobar qué estimaciones de parámetros no son significativamente distintas de 0. Veamos entonces qué parámetro fijamos a 0 en primer lugar. 

```{r}
abs(ajuste$coef)/(1.96*sqrt(diag(ajuste$var.coef)))
```
Fijamos a cero el coeficiente `ma3`.

```{r}
fixed.params <- rep(NA, 6)
fixed.params[3] <- 0
```


```{r}
ajuste <- Arima(Y, xreg=X, order=c(0, 0, 4), fixed=fixed.params)
ajuste
```

Comprobamos de nuevo qué parámetros no son significativamente distintos de cero.

```{r}
abs(ajuste$coef[ajuste$coef != 0]) / (1.96 * sqrt(diag(ajuste$var.coef)))
```


LA estimación del coeficiente `ma1` tampoco es significativamente distinta de 0.

```{r}
fixed.params[1] <- 0

ajuste <- Arima(Y, xreg=X, order=c(0, 0, 4), fixed=fixed.params)
ajuste
```

Volvemos a comprobar cuáles son significativamente distintos de cero:

```{r}
abs(ajuste$coef[ajuste$coef != 0]) / (1.96 * sqrt(diag(ajuste$var.coef)))
```

Con este ajuste, todos son significativamente distinots de cero. Podemos incluso modelizar el efecto de los atípicos (si existiesen):

```{r}
TSA::detectAO(ajuste)
TSA::detectIO(ajuste)
```

### Diagnosis o análisis de residuos

```{r}
checkresiduals(ajuste)
tsdiag(ajuste)
t.test(ajuste$residuals, mu=0)
```

```{r}
qqnorm(ajuste$residuals)
qqline(ajuste$residuals)
jarque.bera.test(ajuste$residuals)
shapiro.test(ajuste$residuals)
```
* La media de los errores es 0.
* Las innovaciones del ARMA son gaussianas.
* Se ha superado el test de independencia.


Conclusión: El modelo ajustado puede ser utilizado para modelizar la relación entre las ventas y el precio. Además, las innovaciones son gaussianas.

Dicho modelo es:

$$ \log(\text{Ventas}_t) = 15.86 - 2.47 \cdot \text{Precio}_t + 0.29a_{t-2} + 0.54 a_{t-4} + a_t $$

donde $a_t$ es ruido balnco gaussiano con varianza $\sigma_a^2 = 0.02728$. Como es de esperar, el aumento del precio provocan disminuciones en las ventas medias en escala logarítmica.



### Predicción con el ajuste

Si se planea subir el precio de la primera semana (semana 105) a 1.9 unidades (el precio de la semana 104 fue de 1.73), ¿qué valor pronosticamos para las ventas?

```{r}
pred.norm <- forecast(ajuste, xreg=1.9, h=1)
pred.norm$meanç
```

```{r}
autoplot(pred.norm) + ylab("log(Ventas)") + xlab("Precio") +
  ggtitle("IP obtenidos a través de la distribución asintótica de los errores de predición")
```

```{r}
exp(pred.norm$mean)
```


Predicción de las ventas: $\text{Ventas}_{105} = 62936.83$ (la semana pasada fueron 89196).


**Posición del cliente**: El clietne no conoce cuál será el precio la próxima semana. ¿Qué procedimiento puede entonces utilizar para predecir las ventas de la próxima semana?


Respuesta. Primero predice a partir de un modelo Box-Jenkins el valor del precio de la próxima semana (semana 105). Posteriormente utiliza dicha predicción para predecir, a partir del modelo de regresión ajustado, el valor de las ventas de la próxima semana.

1. ¿Cuál es la predición del precio de la próxima semana?
2. ¿Cuál es la predicción de las ventas de la próxima semana?






















